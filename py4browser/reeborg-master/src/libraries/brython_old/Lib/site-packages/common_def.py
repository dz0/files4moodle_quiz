import sys
from browser import window
from highlight import insert_highlight_info

library = window['library']


def _write(data):
    window.RUR.control.write(str(data)[:-1])


def _write_err(data):
    window.RUR.control.write("<b style='color:red'>" + str(data) + "</b>")


sys.stdout.write = _write
sys.stderr.write = _write_err


def generic_translate_python(src, lib, lang_import, highlight):
    ''' Translate Python code into Javascript and execute

        src: source code in editor
        lib: language specific lib (e.g. my_lib in English, biblio in French)
             already imported in html file
        lang_import: something like "from reeborg_en import *"
    '''
    # save initial state of lib
    initial_lib_dict = {}
    for key in lib.__dict__:
        initial_lib_dict[key] = lib.__dict__[key]

    exec(library.getValue(), lib.__dict__)
    exec(lang_import)
    if highlight:
        temp_src, success = insert_highlight_info(src)
        if success:
            src = temp_src
        else:
            exec("RUR.ui.highlight()")
            window.jQuery("#highlight-impossible").show()
    exec(src)

    # remove added definitions
    new_keys = []
    for key in lib.__dict__:
        if key not in initial_lib_dict:
            new_keys.append(key)
        else:
            lib.__dict__[key] = initial_lib_dict[key]

    for key in new_keys:
        del lib.__dict__[key]
